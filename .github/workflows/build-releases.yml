name: Build Multi-Platform Releases

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  web-build:
    name: Build Web Version
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'game/package-lock.json'
        
    - name: Install dependencies
      run: |
        cd game
        npm ci
        
    - name: Lint
      run: |
        cd game
        npm run lint
        
    - name: Build PWA
      run: |
        cd game
        npm run build
        
    - name: Upload web build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: game/dist/
        retention-days: 30

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [web-build]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: Create release archives
      run: |
        cd artifacts
        
        # Create web version archive
        cd web-build
        zip -r ../echoes-of-ellidra-web.zip .
        cd ..
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üéÆ Echoes of Ellidra - Web Release
          
          **Available Platforms:**
          - üåê **Web Version**: Play directly in your browser
          
          ### Installation Instructions:
          - **Web**: Visit the deployment URL or extract and host the web archive
          
          ### Features:
          - Full visual novel experience
          - Faction system with consequences
          - Ellidric language mechanics
          - Save/load system
          - Responsive design for various screen sizes